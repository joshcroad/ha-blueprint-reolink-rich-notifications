blueprint:
  name: Reolink Camera Alert (iOS, Proxy Image)
  description: >
    iOS snapshot-style notification using camera proxy (requires FULL https URL)
    with buttons:
      • Open dashboard (optional)
      • Open external (optional)

    Includes presence filter, quiet hours, cooldown, iOS live view, and iOS sound volume.
  domain: automation

  input:
    # Triggers
    person_sensor:
      name: Person sensor (binary_sensor)
      selector:
        entity:
          domain: binary_sensor

    extra_sensors:
      name: Additional event sensors (optional)
      description: Doorbell/visitor etc. Leave empty if not used.
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain:
              - binary_sensor

    # Camera
    camera:
      name: Camera entity
      selector:
        entity:
          domain: camera

    # Target devices (iOS devices using mobile_app)
    notify_devices:
      name: iPhones/iPads to notify (mobile_app)
      selector:
        device:
          integration: mobile_app
          multiple: true

    # --- NEW: Base URL for iOS attachments ---
    base_url:
      name: External Base URL (required for iOS attachments)
      description: >
        Full URL to your Home Assistant (e.g., https://ha.example.com).
        Must be reachable from the phone (Wi-Fi & cellular). Nabu Casa URL works.
      default: ""
      selector:
        text:

    # Texts
    custom_title:
      name: Notification title (optional)
      default: ""
      selector: { text: {} }

    custom_message:
      name: Notification text (optional)
      description: >
        Placeholders: {camera_name}, {event}.
        Blank → "Person detected at {camera_name}".
      default: ""
      selector: { text: {} }

    open_dashboard:
      name: Dashboard to open
      default: "/dashboard-minimist/cameras"
      selector: { text: {} }

    open_dashboard_title:
      name: Open dashboard button label
      default: "Open dashboard"
      selector: { text: {} }

    open_uri:
      name: URI to open
      default: "reolink://"
      selector: { text: {} }

    open_uri_title:
      name: Open URI button label
      default: "Open Reolink"
      selector: { text: {} }

    # Filters
    presence_filter_enabled:
      name: Enable presence filter
      default: false
      selector: { boolean: {} }

    presence_entities:
      name: Presence entities (people/device trackers/groups)
      description: Only notify if ALL of these are NOT home.
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain:
              - device_tracker
              - person
              - group

    disable_hours:
      name: Quiet hours (0–23, optional)
      default: []
      selector:
        select:
          multiple: true
          options:
            - "0"
            - "1"
            - "2"
            - "3"
            - "4"
            - "5"
            - "6"
            - "7"
            - "8"
            - "9"
            - "10"
            - "11"
            - "12"
            - "13"
            - "14"
            - "15"
            - "16"
            - "17"
            - "18"
            - "19"
            - "20"
            - "21"
            - "22"
            - "23"

    cooldown_seconds:
      name: Cooldown (seconds, optional)
      default: 0
      selector:
        number:
          min: 0
          max: 86400
          mode: box

    # iOS specifics
    ios_live_view_entity:
      name: iOS Live View entity (optional)
      description: Attach live view from this entity in iOS notifications.
      default: ""
      selector:
        entity:
          multiple: false
          filter:
            domain:
              - camera

    ios_sound_name:
      name: iOS Sound name
      description: Use "default" for default sound, or "none" for no sound.
      default: "default"
      selector:
        select:
          options:
            - default
            - none
          custom_value: true

    ios_sound_volume:
      name: iOS Sound volume (0–100)
      default: 100
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: slider

    ios_critical:
      name: iOS Critical alert (bypass mute/DND)
      default: false
      selector:
        boolean: {}

    # (Optional) also save a rolling snapshot on disk (not required for iOS)
    filename_stem:
      name: Snapshot filename stem (no extension)
      default: "camera"
      selector: { text: {} }

mode: queued
max: 10

triggers:
  - id: person
    platform: state
    entity_id: !input person_sensor
    to: "on"

  - id: extra
    platform: template
    value_template: >-
      {% set ents = expand(extra_sensors_list) %}
      {% if ents | length == 0 %}
        false
      {% else %}
        {{ (ents | selectattr('state','eq','on') | list | length) > 0 }}
      {% endif %}

# Variables
variables:
  camera_entity: !input camera
  cam_name: "{{ state_attr(camera_entity, 'friendly_name') or camera_entity }}"
  extra_sensors_list: !input extra_sensors

  notify_device_ids: !input notify_devices
  notify_ids_list: >-
    {{ notify_device_ids if notify_device_ids is iterable else [notify_device_ids] }}

  custom_title_text: !input custom_title
  custom_message_text: !input custom_message

  # Build FULL iOS attachment URL: <base_url>/api/camera_proxy/<entity_id>?token=...
  base_url_input: !input base_url
  camera_proxy_path: >-
    {{ '/api/camera_proxy/' ~ camera_entity
       ~ (('?token=' ~ state_attr(camera_entity,'access_token')) if state_attr(camera_entity,'access_token') else '') }}
  camera_proxy_full: >-
    {{ (base_url_input | trim).rstrip('/') ~ camera_proxy_path }}

  # Optional rolling snapshot (kept for parity; not required for iOS)
  filename_stem_var: !input filename_stem
  snap_abs: "{{ '/media/reolink/' ~ filename_stem_var ~ '_latest.jpg' }}"
  bust: "{{ (now() | as_timestamp) | int }}"

  presence_filter_enabled_var: !input presence_filter_enabled
  presence_entities_list: !input presence_entities

  disable_hours_raw: !input disable_hours
  disable_hours_list: "{{ (disable_hours_raw | map('int') | list) if disable_hours_raw is iterable else [] }}"

  cooldown_seconds_var: !input cooldown_seconds

  open_dashboard_text: !input open_dashboard
  open_dashboard_title_text: !input open_dashboard_title
  open_uri_text: !input open_uri
  open_uri_title_text: !input open_uri_title

  ios_live_view_entity: !input ios_live_view_entity
  ios_sound_name_var: !input ios_sound_name
  ios_sound_volume_var: !input ios_sound_volume
  ios_sound_volume_float: "{{ (ios_sound_volume_var | int(100)) / 100 }}"
  ios_critical_var: !input ios_critical

conditions: []

actions:
  - choose:
      # ---------- Main notification path ----------
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['person','extra'] }}"
        sequence:
          # Cooldown
          - condition: template
            value_template: >-
              {{ cooldown_seconds_var == 0
                 or not this.attributes.last_triggered
                 or (now() - this.attributes.last_triggered).total_seconds() > cooldown_seconds_var }}

          # Presence filter
          - condition: template
            value_template: >-
              {% if presence_filter_enabled_var %}
                {{ (expand(presence_entities_list)
                    | selectattr('state','eq','home')
                    | list | length) == 0 }}
              {% else %} true {% endif %}

          # Quiet hours
          - condition: template
            value_template: >-
              {{ (disable_hours_list | length == 0)
                 or (now().hour not in disable_hours_list) }}

          # (Optional) also save a rolling snapshot file
          - action: camera.snapshot
            data:
              entity_id: !input camera
              filename: "{{ snap_abs }}"
          - delay: "00:00:01"

          - variables:
              title_final: "{{ custom_title_text | trim }}"
              event_text: "{{ 'Person detected' if trigger.id == 'person' else 'Event' }}"
              msg_default: "{{ 'Person detected at ' ~ cam_name }}"
              msg_final: >-
                {% set base = custom_message_text | trim %}
                {% if base == '' %}
                  {{ msg_default }}
                {% else %}
                  {{ base
                     | replace('{camera_name}', cam_name)
                     | replace('{event}', event_text) }}
                {% endif %}

          # Send to each selected iOS device via its mobile_app notify service
          - repeat:
              for_each: "{{ notify_ids_list }}"
              sequence:
                - service: "{{ 'notify.mobile_app_' ~ (device_attr(repeat.item,'name') | slugify) }}"
                  data:
                    title: "{{ title_final }}"
                    message: "{{ msg_final }}"
                    data:
                      attachment:
                        url: "{{ camera_proxy_full }}"
                        content-type: jpeg
                      push:
                        sound:
                          name: "{{ ios_sound_name_var }}"
                          volume: "{{ 0 if ios_sound_name_var == 'none' else ios_sound_volume_float }}"
                          critical: "{{ 1 if ios_critical_var else 0 }}"
                      actions:
                        - action: OPEN_REOLINK
                          title: "{{ open_url_title_text }}"
                          uri: "{{ open_url_text }}"
                        - action: OPEN_LIVE
                          title: Open Live View
                          uri: "//front-door"

    default: []
